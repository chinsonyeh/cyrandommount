# 功能規格：CYRandomMount 基礎功能

**功能分支**: `1-baseline`  
**建立日期**: 2025-11-23  
**狀態**: 已實作  
**輸入**: 現有程式碼分析和功能文件

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 自動召喚適合區域的坐騎 (優先級: P1)

玩家在魔獸世界中移動時，需要能快速召喚適合當前區域的坐騎。在可飛行區域使用飛行坐騎，在地面專屬區域使用地面坐騎，無需手動判斷或切換。

**優先級理由**: 這是插件的核心價值，提供最基本的自動化坐騎選擇功能。

**獨立測試**: 玩家進入不同區域（飛行區域、地面專屬區域）並使用 CYRandomMount 巨集，系統自動選擇並召喚正確類型的坐騎。

**驗收場景**:

1. **假設** 玩家位於可飛行區域（如暴風城外），**當** 玩家執行 CYRandomMount 巨集，**那麼** 系統隨機召喚一個玩家選定的飛行坐騎
2. **假設** 玩家位於地面專屬區域（如某些副本入口），**當** 玩家執行巨集，**那麼** 系統隨機召喚一個玩家選定的地面坐騎
3. **假設** 玩家已經騎乘坐騎，**當** 玩家再次執行巨集，**那麼** 系統先執行即時更新巨集內容，然後下馬

---

### 使用者故事 2 - 透過設定面板管理偏好坐騎 (優先級: P1)

玩家需要能夠選擇哪些坐騎要納入隨機選擇池中。每個角色分別管理自己的飛行坐騎和地面坐騎選擇清單，只有勾選的坐騎才會被隨機召喚。

**優先級理由**: 讓玩家掌控自己的坐騎偏好是基本需求，沒有這個功能插件就失去個人化價值。

**獨立測試**: 玩家在不同角色下開啟設定面板，看到各自角色已收藏的坐騎清單（分為飛行和地面兩類），勾選想要的坐騎後，只有該角色勾選的坐騎會出現在隨機選擇中。

**驗收場景**:

1. **假設** 玩家輸入 `/cyrandommount` 指令，**當** 設定面板開啟，**那麼** 顯示飛行坐騎和地面坐騎兩個獨立的選擇區塊
2. **假設** 玩家勾選 5 個飛行坐騎和 3 個地面坐騎，**當** 設定儲存，**那麼** 系統只從這些選定的坐騎中隨機選擇
3. **假設** 玩家取消勾選某個坐騎，**當** 設定更新後，**那麼** 該坐騎不再出現在隨機選擇中
4. **假設** 玩家切換角色或登出再登入，**當** 開啟設定面板，**那麼** 各角色的選擇狀態分別保留且互不影響

---

### 使用者故事 3 - 特殊區域專屬坐騎（地底城 Undermine）(優先級: P2)

在特定區域（如 11.1 版本的地底城 Undermine，區域 ID 2346），系統必須自動使用該區域專屬的坐騎（斷頸者 G-99），而不是隨機選擇。

**優先級理由**: 遊戲特定區域有強制坐騎要求，這是功能正確性的必要條件。

**獨立測試**: 玩家進入地底城 Undermine，執行巨集時自動召喚斷頸者 G-99，且根據客戶端語言顯示正確的坐騎名稱。

**驗收場景**:

1. **假設** 玩家進入地底城 Undermine（區域 ID 2346），**當** 執行巨集，**那麼** 系統召喚斷頸者 G-99 而非隨機坐騎
2. **假設** 玩家使用繁體中文客戶端，**當** 在 Undermine 召喚坐騎，**那麼** 巨集內容顯示「斷頸者G-99」
3. **假設** 玩家使用英文客戶端，**當** 在 Undermine 召喚坐騎，**那麼** 巨集內容顯示「G-99 Breakneck」
4. **假設** 玩家離開 Undermine 進入一般區域，**當** 執行巨集，**那麼** 系統恢復正常的隨機坐騎選擇邏輯

---

### 使用者故事 4 - 選擇巨集更新時機模式 (優先級: P2)

玩家可以選擇巨集更新的觸發方式：即時更新（推薦，每次按下巨集時更新）或週期更新（遺留模式，每隔固定時間自動更新）。

**優先級理由**: 提供彈性選擇，滿足不同玩家的使用習慣，但預設值已足夠大多數情況。

**獨立測試**: 玩家在設定面板切換更新模式，驗證巨集更新行為符合選擇的模式。

**驗收場景**:

1. **假設** 玩家選擇「即時更新」模式，**當** 未騎乘狀態下按下巨集，**那麼** 系統先開始騎乘座騎，並更新巨集內容為新的隨機座騎。**若**玩家騎乘引導過程時中斷之，則巨集仍應更新為新的隨機座騎。 
2. **假設** 玩家選擇「週期更新」模式並設定刷新時間為 10 秒，**當** 經過 10 秒，**那麼** 系統自動更新巨集內容（無需玩家操作）
3. **假設** 玩家正在編輯巨集視窗，**當** 週期更新觸發時，**那麼** 系統暫停更新避免干擾玩家編輯

---

### 使用者故事 5 - 調整週期更新刷新時間 (優先級: P3)

當使用週期更新模式時，玩家可以自訂巨集自動更新的時間間隔（5-30 秒）。

**優先級理由**: 這是進階設定，只影響週期更新模式使用者，多數玩家使用即時更新模式。

**獨立測試**: 玩家在設定面板調整刷新時間滑桿，驗證巨集更新頻率符合設定值。

**驗收場景**:

1. **假設** 玩家設定刷新時間為 5 秒，**當** 週期更新模式啟用，**那麼** 巨集每 5 秒更新一次
2. **假設** 玩家設定刷新時間為 30 秒，**當** 週期更新模式啟用，**那麼** 巨集每 30 秒更新一次
3. **假設** 玩家調整滑桿，**當** 移動滑桿，**那麼** 設定面板即時顯示當前選擇的秒數

---

### 使用者故事 6 - 手動重置巨集內容 (優先級: P3)

玩家可以在設定面板中手動觸發巨集重置，立即更新巨集內容為新的隨機坐騎。

**優先級理由**: 提供方便的手動控制選項，但非核心功能（因為正常使用時自動更新已足夠）。

**獨立測試**: 玩家點擊設定面板的「Press」按鈕，巨集立即更新為新的隨機坐騎。

**驗收場景**:

1. **假設** 玩家開啟設定面板，**當** 點擊「Reset Macro」旁的「Press」按鈕，**那麼** 系統立即執行一次巨集更新
2. **假設** 巨集更新後，**當** 玩家檢視巨集內容，**那麼** 顯示新選擇的隨機坐騎

---

### 使用者故事 7 - 選擇使用角色獨立或帳號共用坐騎清單 (優先級: P2)

玩家可以選擇每個角色使用自己獨立的坐騎清單，或使用帳號共用的坐騎清單。當選擇共用清單時，所有角色共用同一份坐騎選擇，編輯時直接修改共用清單。

**優先級理由**: 提供彈性管理方式，讓玩家可以選擇「每個角色不同偏好」或「所有角色統一管理」，滿足不同使用習慣。

**獨立測試**: 玩家在設定面板切換清單模式（角色獨立/帳號共用），驗證編輯目標和隨機選擇來源符合選擇的模式。

**驗收場景**:

1. **假設** 玩家選擇「角色獨立清單」模式（預設），**當** 編輯坐騎選擇，**那麼** 只影響當前角色的清單，其他角色不受影響
2. **假設** 玩家選擇「帳號共用清單」模式，**當** 編輯坐騎選擇，**那麼** 編輯的是 Default 共用清單，所有選擇此模式的角色都使用相同清單
3. **假設** 玩家在角色 A 選擇共用清單模式並編輯清單，**當** 切換到角色 B 並也選擇共用清單模式，**那麼** 角色 B 看到的清單與角色 A 編輯後的一致
4. **假設** 玩家在角色 A 使用共用清單、角色 B 使用獨立清單，**當** 修改共用清單，**那麼** 只有角色 A 的隨機選擇受影響，角色 B 使用自己的獨立清單
5. **假設** 玩家切換清單模式，**當** 從獨立清單切換到共用清單，**那麼** UI 立即顯示 Default 共用清單的勾選狀態
6. **假設** 玩家切換清單模式，**當** 從共用清單切換回獨立清單，**那麼** UI 立即顯示當前角色專屬清單的勾選狀態

---

### 邊界情況

- **當玩家位於室內區域時**，系統不更新巨集（因為室內無法召喚坐騎）
- **當當前角色選擇的坐騎清單為空時**，系統不執行隨機選擇（避免錯誤）
- **當玩家收藏新坐騎或移除舊坐騎時**，設定面板重新開啟時會刷新可用坐騎清單
- **當坐騎不可用時（如尚未學習或當前職業/種族無法使用）**，系統自動過濾該坐騎
- **當玩家正在編輯巨集視窗（MacroFrame 顯示中）時**，系統暫停自動更新避免干擾
- **當巨集內容超過 255 字元限制時**，系統必須妥善處理錯誤（雖然目前設計不應發生）
- **當 WoW API 呼叫失敗時**，系統使用 pcall 捕捉錯誤並顯示友善訊息

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須在插件載入時自動建立名為 "CYRandomMount" 的巨集（若不存在）
- **FR-002**: 系統必須偵測玩家當前區域是否可飛行（使用 `IsFlyableArea()` API）
- **FR-003**: 系統必須根據區域飛行狀態選擇適合的坐騎類型（飛行或地面）
- **FR-004**: 系統必須從當前角色選定的坐騎清單中隨機選擇一個
- **FR-005**: 系統必須過濾不可用的坐騎（使用 `C_MountJournal.GetMountInfoByID` 檢查 isUsable）
- **FR-006**: 系統必須將選定坐騎更新到 CYRandomMount 巨集中（使用 `EditMacro` API）
- **FR-007**: 系統必須提供設定面板讓玩家為每個角色分別勾選偏好的飛行坐騎和地面坐騎
- **FR-008**: 系統必須將每個角色的設定持久儲存在 `CYRandomMountDB` SavedVariable 中，並以角色為單位分開儲存
- **FR-009**: 系統必須支援兩種巨集更新模式：即時更新和週期更新
- **FR-010**: 系統必須在週期更新模式下依據設定的刷新時間（5-30 秒）自動更新巨集
- **FR-011**: 系統必須在即時更新模式下於玩家騎乘時執行 `CYRandomMount_InstantUpdate()` 更新巨集
- **FR-012**: 系統必須偵測玩家是否正在編輯巨集視窗，若是則暫停自動更新
- **FR-013**: 系統必須在區域變更事件（ZONE_CHANGED*、PLAYER_ENTERING_WORLD）觸發時延遲 1 秒後更新巨集
- **FR-014**: 系統必須針對地底城 Undermine（區域 ID 2346）使用專屬坐騎「斷頸者 G-99」
- **FR-015**: 系統必須根據客戶端語言（GetLocale）選擇正確的坐騎名稱（支援繁中、簡中、英文等多種語言）
- **FR-016**: 系統必須在設定面板提供「Reset Macro」按鈕讓玩家手動觸發巨集更新
- **FR-017**: 系統必須在首次執行時初始化 CYRandomMountDB（若不存在）
- **FR-018**: 系統必須處理舊版巨集名稱遷移（若 macroName 不同則刪除舊巨集並使用新名稱）
- **FR-019**: 系統必須使用 pcall 包裝所有可能失敗的 API 呼叫（如 EditMacro、DeleteMacro）
- **FR-020**: 系統必須將飛行坐騎也加入地面坐騎清單（因為飛行坐騎在地面也可使用）
- **FR-021**: 系統必須提供清單模式選項讓玩家選擇「角色獨立清單」或「帳號共用清單」
- **FR-022**: 系統必須在選擇「角色獨立清單」模式時，儲存和讀取當前角色專屬的坐騎清單
- **FR-023**: 系統必須在選擇「帳號共用清單」模式時，儲存和讀取 CYRandomMountDB["Default"] 共用清單
- **FR-024**: 系統必須在切換清單模式時，立即更新 UI 顯示對應清單的勾選狀態
- **FR-025**: 系統必須根據角色的 ListMode 設定，從對應來源（角色專屬或 Default）讀取坐騎清單進行隨機選擇


### 關鍵實體

- **CYRandomMountDB（SavedVariable）**: 儲存每個角色設定的持久資料，結構如下：
  - `Default`: 帳號共用的預設設定檔，包含共用坐騎清單
    - `macroName`: 巨集名稱（預設 "CYRandomMount"）
    - `RefreshTime`: 週期更新模式的刷新時間（5-30 秒，預設 10）
    - `UpdateMacroMode`: 巨集更新模式（1=即時更新，2=週期更新）
    - `ListMode`: 清單模式（1=角色獨立清單，2=使用共用清單）
    - `FlyingMounts`: 共用飛行坐騎 ID 陣列
    - `GroundMounts`: 共用地面坐騎 ID 陣列
    - `availableMountsCount`: 可用坐騎總數（用於檢測坐騎收藏變化）
  - `<角色唯一識別碼>`: 每個角色一個子表，內容如下：
    - `macroName`: 巨集名稱（預設 "CYRandomMount"）
    - `RefreshTime`: 週期更新模式的刷新時間（5-30 秒，預設 10）
    - `UpdateMacroMode`: 巨集更新模式（1=即時更新，2=週期更新）
    - `ListMode`: 清單模式（1=角色獨立清單，2=使用共用清單，預設 1）
    - `FlyingMounts`: 當前角色選定的飛行坐騎 ID 陣列（僅 ListMode=1 時使用）
    - `GroundMounts`: 當前角色選定的地面坐騎 ID 陣列（僅 ListMode=1 時使用）
    - `availableMountsCount`: 可用坐騎總數（用於檢測坐騎收藏變化）

- **坐騎資訊**: 從 WoW API 取得的坐騎屬性
  - `mountID`: 坐騎唯一識別碼
  - `name`: 坐騎名稱（根據客戶端語言）
  - `icon`: 坐騎圖示材質路徑
  - `isUsable`: 是否可在當前情況下使用
  - `isCollected`: 是否已收藏
  - `mountTypeID`: 坐騎類型（402/269=飛行龍騎，241/424=一般飛行，其他=地面）

- **設定面板元件**:
  - `refreshTimeSlider`: 刷新時間滑桿（5-30 秒）
  - `updateMacroRadio1/2`: 巨集更新模式單選按鈕
  - `listModeRadio1/2`: 清單模式單選按鈕（1=角色獨立清單，2=帳號共用清單）
  - `flyingBox`: 飛行坐騎複選框清單（根據 ListMode 顯示角色專屬或共用清單）
  - `groundBox`: 地面坐騎複選框清單（根據 ListMode 顯示角色專屬或共用清單）
  - `resetMacroButton`: 手動重置巨集按鈕

## 成功標準 *(必填)*

### 可量化成果

- **SC-001**: 玩家在 90% 的情況下能在切換區域後 1 秒內獲得正確類型的坐騎（無需手動干預，且每個角色的偏好獨立生效）
- **SC-002**: 設定面板能在 2 秒內完整載入並顯示所有可用坐騎（即使玩家擁有 200+ 坐騎，且多角色切換時正確顯示各自清單）
- **SC-003**: 插件的記憶體佔用不超過 5MB（在 100 個坐騎選擇情況下，單一角色）
- **SC-004**: 每個角色的設定在登出登入或切換角色後 100% 完整保留（無資料遺失，互不干擾）
- **SC-005**: 系統在玩家編輯巨集時 100% 不干擾（暫停自動更新）
- **SC-006**: 多語言環境下坐騎名稱正確率 100%（支援的語言清單中）
- **SC-007**: 即時更新模式下，巨集內容在每次按下時 100% 更新為新的隨機選擇
- **SC-008**: 週期更新模式下，巨集更新誤差不超過 ±1 秒（與設定的刷新時間相比）
- **SC-009**: 特殊區域（Undermine）專屬坐騎識別準確率 100%
- **SC-010**: API 錯誤處理覆蓋率 100%（所有可能失敗的 API 呼叫都使用 pcall 包裝）
- **SC-011**: 切換清單模式後，UI 顯示的坐騎勾選狀態在 1 秒內更新完成（準確率 100%）
- **SC-012**: 使用共用清單模式的角色，編輯清單後所有使用共用清單的角色都能讀取到最新清單（一致性 100%）

## 假設與約束

### 假設
- 玩家至少擁有一個可用坐騎
- 玩家的 WoW 客戶端版本為 11.0 或更高
- 玩家有足夠的巨集欄位可用（未超過 120 個帳號巨集上限）
- 網路連線穩定，API 呼叫不會異常延遲

### 技術約束
- 受限於 WoW Lua API 和事件系統
- 巨集內容限制 255 字元
- SavedVariables 載入順序依賴 WoW 客戶端事件順序
- 無法直接偵測「是否可召喚坐騎」（只能用 IsIndoors 等間接判斷）

### 相依性
- 依賴 WoW 11.0+ Settings API（向下相容 InterfaceOptions API）
- 依賴 C_MountJournal API 取得坐騎資訊
- 依賴 C_Map API 取得區域 ID
- 依賴 IsFlyableArea API 判斷飛行狀態
